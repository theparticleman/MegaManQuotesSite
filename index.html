<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Mega Man Quotes</title>
    <link rel="stylesheet" href="site.css">
    <link rel="shortcut icon" href="/favicon-128.png">
    <link rel="icon" sizes="16x16" href="/favicon-16.png">
    <link rel="icon" sizes="32x32" href="/favicon-32.png">
    <link rel="icon" sizes="128x128" href="/favicon-128.png">
    <link rel="icon" sizes="256x256" href="/favicon-256.png">
</head>

<body>
    <section>
        <main>
            <div id="quote-display">
                <h1>Mega Man Quotes</h1>
                <a href="/"><img src="Mega Man.png" alt="Mega Man"></a>
                <div id="quote"></div>
            </div>
            <div class="buttons">
                <a href="/search"><div class="searchButton">Search Quotes</div></a>
                <button id="copyImageButton" onclick="generateImage()">â§‰</button>
            </div>
        </main>
        <footer>
            <a href="https://mythicant.com">Mythicant</a>
            <a href="https://github.com/theparticleman/MegaManQuotesCli">CLI</a>
            <a href="api">API</a>
            <a href="about">About</a>
        </footer>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        function getQuote() {
            let url = getUrl();
            fetch(url)
                .then(res => res.json())
                .then(quote => {
                    var quoteDiv = document.getElementById('quote');
                    var quoteLink = document.createElement('a');
                    quoteLink.classList.add('quote-link');
                    quoteLink.href = '/?id=' + quote.id;
                    var quoteText = document.createElement('q');
                    quoteText.classList.add('quote-text');
                    quoteText.innerHTML = quote.text;
                    quoteLink.appendChild(quoteText);
                    var quoteAuthor = document.createElement('p');
                    quoteAuthor.classList.add('quote-author');
                    quoteAuthor.innerHTML = quote.author;
                    quoteLink.appendChild(quoteAuthor);
                    var quoteSource = document.createElement('p');
                    quoteSource.classList.add('quote-source');
                    quoteSource.innerHTML = quote.source;
                    quoteLink.appendChild(quoteSource);
                    quoteDiv.appendChild(quoteLink);
                });
        }
        function getUrl() {
            const params = new URLSearchParams(location.search);
            if (params.has('id')) {
                return 'https://api.megamanquotes.com/quotes/' + params.get('id');
            } else {
                return 'https://api.megamanquotes.com/random-quote';
            }
        }

        async function generateImage() {
            const button = document.getElementById('copyImageButton');
            const originalText = button.textContent;
            
            try {
                button.textContent = 'Generating...';
                button.disabled = true;

                const element = document.getElementById('quote-display');
                const canvas = await html2canvas(element, {
                    backgroundColor: '#000000',
                    scale: 2
                });

                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        button.textContent = 'Copied!';
                    } catch (err) {
                        console.error('Failed to copy image:', err);
                        button.textContent = 'Copy failed';
                    }
                });
            } catch (err) {
                console.error('Failed to generate image:', err);
                button.textContent = 'Generation failed';
            } finally {
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        getQuote();
    </script>

    <!-- Lame Google Tag Manager stuff -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNFTGSSJWE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-YNFTGSSJWE');
    </script>
</body>

</html>